# =============================================================================
# MTChat CI - Runs on every PR and push to master
# =============================================================================
name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Rust Backend
  # ===========================================================================
  rust-fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --manifest-path mtchat-rust/Cargo.toml --check

  rust-clippy:
    name: Rust Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mtchat-rust
      - run: cargo clippy --manifest-path mtchat-rust/Cargo.toml -- -D warnings

  rust-test-unit:
    name: Rust Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mtchat-rust
      - name: Run unit tests
        run: cargo test --manifest-path mtchat-rust/Cargo.toml --lib

  rust-test-integration:
    name: Rust Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mtchat_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mtchat-rust
      - name: Run integration tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/mtchat_test
          TEST_DATABASE_URL: postgres://postgres:postgres@localhost:5432/mtchat_test
          REDIS_URL: redis://localhost:6379
        run: cargo test --manifest-path mtchat-rust/Cargo.toml --tests

  rust-build:
    name: Rust Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mtchat-rust
      - run: cargo build --manifest-path mtchat-rust/Cargo.toml --release

  # ===========================================================================
  # Vue SDK (@mtchat/vue)
  # ===========================================================================
  vue-sdk:
    name: Vue SDK (typecheck + build)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mtchat-vue
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mtchat-vue/package-lock.json
      - run: npm ci
      - run: npm run typecheck
      - run: npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: mtchat-vue-dist
          path: mtchat-vue/dist/
          retention-days: 1

  # ===========================================================================
  # Vue PrimeVue Wrapper (@mtchat/vue-primevue)
  # ===========================================================================
  vue-primevue:
    name: Vue PrimeVue (typecheck + build)
    needs: vue-sdk
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mtchat-vue-primevue/package-lock.json
      - uses: actions/download-artifact@v4
        with:
          name: mtchat-vue-dist
          path: mtchat-vue/dist/
      # Build the base SDK so file: dependency resolves
      - run: npm ci
        working-directory: mtchat-vue
      - run: npm ci
        working-directory: mtchat-vue-primevue
      - run: npm run typecheck
        working-directory: mtchat-vue-primevue
      - run: npm run build
        working-directory: mtchat-vue-primevue

  # ===========================================================================
  # Docker Build (verify it builds, no push)
  # ===========================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./mtchat-rust
          file: ./mtchat-rust/docker/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

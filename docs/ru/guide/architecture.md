# Архитектура

MTChat -- микросервисная чат-система, предназначенная для встраивания в существующие бизнес-приложения. Ваше приложение управляет пользователями и бизнес-логикой; MTChat обеспечивает коммуникации.

## Обзор системы

```
┌───────────────────────────────────────────────────────────┐
│               Ваше приложение                             │
│  ┌─────────────┐              ┌──────────────────────┐    │
│  │  Фронтенд   │              │  Бэкенд              │    │
│  │ ┌────────┐  │              │  - Создание диалогов │    │
│  │ │ MTChat │  │              │  - Управление        │    │
│  │ │Vue SDK │  │              │  - Обработка хуков   │    │
│  │ └───┬────┘  │              └──────────┬───────────┘    │
│  └─────┼───────┘                         │                │ 
└────────┼─────────────────────────────────┼────────────────┘
         │                                 │
         │ Chat API                        │ Management API
         │ (контекст юзера)                │ (Admin Token)
         ▼                                 ▼
┌──────────────────────────────────────────────────────────┐
│                    MTChat Backend                        │
│  ┌──────────────┐  ┌────────────────┐  ┌────────────┐    │
│  │   Chat API   │  │ Management API │  │  Webhooks  │    │
│  │  (юзеры)     │  │   (система)    │  │ (исходящие)│    │
│  └──────────────┘  └────────────────┘  └────────────┘    │
│                                                          │
│  ┌──────────┐  ┌────────────┐  ┌────────────────────┐    │
│  │PostgreSQL│  │   Redis    │  │  S3 / MinIO        │    │
│  │  (данные)│  │(presence,  │  │  (файлы)           │    │
│  │          │  │ задачи)    │  │                    │    │
│  └──────────┘  └────────────┘  └────────────────────┘    │
└──────────────────────────────────────────────────────────┘
```

## Два API

MTChat предоставляет два отдельных API:

### Management API

Вызывается **вашим бэкендом** с использованием админ-токена. Используется для создания диалогов, добавления/удаления участников и управления scope доступа. Это точка интеграции сервер-сервер.

```
POST /api/v1/management/dialogs
POST /api/v1/management/dialogs/{id}/participants
DELETE /api/v1/management/dialogs/{id}
```

### Chat API

Вызывается **Vue SDK** (или любым фронтенд-клиентом) в контексте аутентифицированного пользователя. Предоставляет эндпоинты для списков диалогов, отправки сообщений, присоединения/выхода из чатов и реалтайм-общения через WebSocket.

```
GET  /api/v1/dialogs?type=participating
POST /api/v1/dialogs/{id}/messages
WS   /api/v1/ws
```

## Внутренняя структура бэкенда

Rust-бэкенд структурирован послойно:

```
src/
├── api/           # HTTP-обработчики (REST-эндпоинты)
├── domain/        # Бизнес-сущности и value objects
├── repositories/  # Доступ к БД (sqlx + PostgreSQL)
├── services/      # Внешние интеграции (S3, Redis presence)
├── middleware/     # Аутентификация и extractors
├── webhooks/      # Исходящие уведомления
├── jobs/          # Фоновая обработка задач (apalis)
└── ws/            # WebSocket
```

### Поток запроса

1. HTTP-запрос поступает в обработчик **axum**
2. **Middleware** извлекает идентификацию пользователя и валидирует админ-токены
3. Обработчик вызывает методы **repository** для операций с БД
4. Побочные эффекты запускают **WebSocket-рассылку**, **отправку вебхуков** и **фоновые задачи**

### Инфраструктурные сервисы

| Сервис | Назначение | Обязателен |
|--------|-----------|-----------|
| **PostgreSQL** | Диалоги, сообщения, участники, scope | Да |
| **Redis** | Онлайн-статусы (TTL), очередь задач (apalis), PubSub | Нет |
| **S3 / MinIO** | Хранилище файлов с presigned URLs | Нет |

Все опциональные сервисы деградируют gracefully -- если Redis не настроен, онлайн-статусы и фоновые задачи отключены. Если S3 не настроен, эндпоинты загрузки файлов возвращают ошибки.

## Реалтайм-коммуникация

MTChat использует WebSocket для обновлений в реальном времени:

- **message.new** -- новое сообщение
- **message.edited** / **message.deleted** -- изменения сообщений
- **message.read** -- индикаторы прочтения
- **participant.joined** / **participant.left** -- изменения участников
- **dialog.archived** / **dialog.unarchived** -- изменения архивации
- **presence.update** -- онлайн/оффлайн статус

Vue SDK поддерживает постоянное WebSocket-соединение с автопереподключением и heartbeat (интервал пинга 30 секунд).

## Фоновые задачи

MTChat использует **apalis** с Redis-бэкендом для фоновой обработки:

- **Умные уведомления** -- отложенные уведомления (по умолчанию 30с) с debouncing. Если пользователь получает несколько сообщений до истечения задержки, отправляется только один вебхук.
- **Авто-архивация** -- периодическая задача (по умолчанию: каждые 5 минут) архивирует диалоги, неактивные в течение настраиваемого периода (по умолчанию: 3 дня).

## Исходящие вебхуки

При настройке MTChat отправляет HTTP POST запросы на ваш бэкенд при ключевых событиях:

- `message.new` -- новое сообщение отправлено
- `participant.joined` / `participant.left` -- кто-то присоединился или покинул диалог
- `notification.pending` -- уведомление о непрочитанном сообщении готово (после debounce задержки)

Вебхуки подписаны HMAC-SHA256 для верификации.

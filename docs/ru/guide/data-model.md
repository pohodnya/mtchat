# Модель данных

## Основные сущности

### Диалог (Dialog)

Диалог -- это разговор, привязанный к бизнес-объекту в вашей системе.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID (v7) | Уникальный идентификатор, упорядоченный по времени |
| object_id | UUID | Ссылка на бизнес-объект (обязательно) |
| object_type | STRING | Тип бизнес-объекта (обязательно) |
| title | STRING | Заголовок диалога |
| object_url | STRING | Ссылка на объект в приложении (опционально) |
| created_by | UUID | Пользователь, создавший диалог |
| created_at | TIMESTAMP | Время создания |

- **object_id** + **object_type** связывают диалог с сущностью вашей системы (заказ, тендер, рейс)
- Можно создать несколько диалогов для одного объекта
- **object_url** -- опциональная ссылка на объект в вашем приложении

### Участник (Participant)

Прямой участник диалога. Получает уведомления и видит диалог в списке "Участвую".

| Поле | Тип | Описание |
|------|-----|----------|
| dialog_id | UUID | Ссылка на диалог |
| user_id | UUID | Внешний идентификатор пользователя |
| display_name | STRING | Отображаемое имя |
| company | STRING | Компания пользователя |
| email | STRING | Контактный email (опционально) |
| phone | STRING | Контактный телефон (опционально) |
| joined_at | TIMESTAMP | Время присоединения |
| joined_as | ENUM | "creator" или "member" |
| notifications_enabled | BOOLEAN | Включены ли уведомления |
| last_read_msg_id | UUID | Последнее прочитанное сообщение (nullable) |
| unread_count | INTEGER | Количество непрочитанных сообщений |
| is_archived | BOOLEAN | Архивирован этим пользователем |
| is_pinned | BOOLEAN | Закреплён этим пользователем |

- **user_id** -- внешний идентификатор из вашей системы (не управляется MTChat)
- **display_name** и **company** задаются при присоединении
- **unread_count** отслеживается для каждого участника
- **is_archived** и **is_pinned** -- состояния для каждого пользователя отдельно

### Scope доступа (Access Scope)

Определяет правила для потенциальных участников -- пользователей, которые могут увидеть и присоединиться к диалогу.

| Поле | Тип | Описание |
|------|-----|----------|
| dialog_id | UUID | Ссылка на диалог |
| tenant_uid | STRING | Идентификатор тенанта |
| scope_level1 | STRING[] | Департаменты |
| scope_level2 | STRING[] | Права доступа/роли |

Диалог может иметь несколько scope доступа. Подробности в разделе [Scope-сопоставление](scope-matching.md).

### Сообщение (Message)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID (v7) | Уникальный идентификатор, упорядоченный по времени |
| dialog_id | UUID | Ссылка на диалог |
| sender_id | UUID | Отправитель (nullable для системных сообщений) |
| message_type | ENUM | "user" или "system" |
| content | STRING | Содержимое сообщения (HTML) |
| reply_to_id | UUID | Ссылка на цитируемое сообщение (nullable) |
| is_edited | BOOLEAN | Было ли сообщение отредактировано |
| is_deleted | BOOLEAN | Было ли сообщение удалено |
| created_at | TIMESTAMP | Время создания |
| updated_at | TIMESTAMP | Время последнего обновления |

- Пользовательские сообщения содержат санитизированный HTML (разрешенные теги: `p`, `br`, `strong`, `em`, `u`, `s`, `a`, `ul`, `ol`, `li`, `blockquote`, `code`, `pre`, `span`)
- Системные сообщения (присоединение, выход, создание) имеют `message_type = "system"` и `sender_id = NULL`
- Системные сообщения хранят JSON-контент для i18n-рендеринга на фронтенде
- Отредактированные сообщения имеют `is_edited = true`; удаленные -- `is_deleted = true`

### Вложение (Attachment)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID (v7) | Уникальный идентификатор |
| message_id | UUID | Ссылка на сообщение |
| s3_key | STRING | Ключ объекта в S3 |
| filename | STRING | Оригинальное имя файла |
| content_type | STRING | MIME-тип |
| size | BIGINT | Размер файла в байтах |
| created_at | TIMESTAMP | Время загрузки |

- Файлы хранятся в S3/MinIO и доступны через presigned URLs
- Максимальный размер: 100 МБ
- Максимум 10 вложений на сообщение

## Связи между сущностями

```
Dialog ──┬── Participants (прямые участники)
         ├── Access Scopes (кто может присоединиться)
         └── Messages ── Attachments
                      └── Edit History
```

## Таблицы БД

| Таблица | Описание |
|---------|----------|
| `dialogs` | Диалоги, привязанные к бизнес-объектам |
| `dialog_participants` | Прямые участники с per-user состоянием |
| `dialog_access_scopes` | Scope-правила для потенциальных участников |
| `messages` | Сообщения с поддержкой ответов |
| `attachments` | Файловые вложения к сообщениям |
| `message_edit_history` | История редактирования сообщений |

Все таблицы используют UUIDv7 для первичных ключей (упорядочены по времени для лучшей производительности индексов). Миграции выполняются автоматически при запуске сервера.

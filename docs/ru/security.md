# Безопасность

## Модель аутентификации

### Management API (Admin Token)

Management API защищён статическим bearer-токеном:

```
Authorization: Bearer <ADMIN_API_TOKEN>
```

- Настраивается через переменную окружения `ADMIN_API_TOKEN`
- Используется для server-to-server коммуникации
- Constant-time сравнение токенов предотвращает timing-атаки
- Токен считывается один раз при старте

!!! warning "Храните admin-токен в секрете"
    Admin-токен даёт полный доступ к созданию/удалению диалогов и управлению участниками. Никогда не раскрывайте его фронтенд-клиентам.

### Chat API (ответственность хост-приложения)

Chat API идентифицирует пользователей через параметр `user_id`. **MTChat не аутентифицирует конечных пользователей напрямую.** Это сделано намеренно:

- Ваше приложение управляет аутентификацией (логин, сессии, JWT)
- Ваше приложение передаёт аутентифицированный `user_id` в MTChat SDK
- MTChat доверяет `user_id`, предоставленному SDK

!!! tip "Рекомендация для продакшена"
    В продакшене разместите MTChat за API-шлюзом или reverse proxy, который валидирует пользовательские токены перед пересылкой запросов.

## Контроль доступа

### На основе участников

- Только **прямые участники** могут читать/отправлять сообщения
- Неучастники получают `403 Forbidden`
- Потенциальные участники видят метаданные диалога, но не сообщения

### На основе scope

- Список "Доступные" фильтруется по [scope-правилам](guide/scope-matching.md)
- Пользователи видят только диалоги, соответствующие их `tenant_uid`, `scope_level1` и `scope_level2`

## Санитизация ввода

### HTML-контент

Содержимое сообщений санитизируется на сервере с помощью библиотеки [ammonia](https://docs.rs/ammonia):

**Разрешённые теги:** `p`, `br`, `strong`, `em`, `u`, `s`, `a`, `ul`, `ol`, `li`, `blockquote`, `code`, `pre`, `span`

**Удаляются:** `<script>`, обработчики событий, `javascript:` URL, iframe, формы.

### Клиентская санитизация

Vue SDK использует [DOMPurify](https://github.com/cure53/DOMPurify) для дополнительной клиентской санитизации перед рендерингом HTML. Это обеспечивает защиту в глубину от XSS.

## Безопасность вебхуков

- Заголовок `X-Webhook-Signature` содержит `sha256=<hex-digest>`
- Дайджест вычисляется над телом запроса с использованием `WEBHOOK_SECRET`
- Constant-time сравнение используется внутренне
- Всегда верифицируйте подпись на вашем эндпоинте

## Безопасность файлов

- Типы файлов валидируются по whitelist MIME-типов
- Размер ограничен 100 МБ
- Файлы хранятся в S3 с уникальными UUIDv7-ключами
- URL скачивания presigned и временные
- S3-бакет настроен без публичного доступа

## Чек-лист для продакшена

- [ ] Установить сильный `ADMIN_API_TOKEN` (минимум 32 символа)
- [ ] Установить сильный `WEBHOOK_SECRET`
- [ ] Разместить MTChat за reverse proxy с TLS (HTTPS)
- [ ] Ограничить CORS доменами вашего приложения
- [ ] Убедиться, что хост-приложение аутентифицирует пользователей перед предоставлением SDK
- [ ] Использовать `user_id` из вашей системы аутентификации
- [ ] Установить подходящий `RUST_LOG` для продакшена
- [ ] Настроить `S3_PUBLIC_ENDPOINT` на HTTPS
- [ ] Мониторить `/health` и `/health/ready`
- [ ] Рассмотреть rate limiting на уровне reverse proxy
